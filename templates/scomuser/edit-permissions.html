<div class="row">
<div class="col-md-12">


<div class="panel panel-primary">
<div class="panel-heading">
	<h3 class="panel-title">Update User Permissions</h3>
	</div>
	<div class="panel-body">
	<form name='add-permission' action="/scomuser/permission/add/" method="post">{% csrf_token %}
	<input type="hidden" value="{{ user_obj.id }}" name="user_id">
	<table>
	<tr>
		<td>
			<select id='edit-permissions' multiple='multiple'>
				{% for perm in all_permissions %}
					<option data-model="{{ perm.content_type_id }}" value="{{ perm.codename }}" {% if perm in permissions %} selected {% endif %}>{{ perm.name }}</option>
				{% endfor %}

			</select>
		</td>
	</tr>
	<tr>
		<td style="padding-top: 20px;">
			<button type="submit" class="btn btn-lg">Update Permission</button>
		</td>
	</tr>
		
	</table>
	</form>
	</div>
</div>

</div>
</div>
<script type="text/javascript">
(function(){

	$('#edit-permissions').multiSelect({
		selectableHeader: "<input type='text' class='search-input form-control' autocomplete='off' placeholder='search permission'>",
		selectionHeader: "<input type='text' class='search-input form-control' autocomplete='off' placeholder='search permission'>",
		afterInit: function(ms){
		var that = this,
		    $selectableSearch = that.$selectableUl.prev(),
		    $selectionSearch = that.$selectionUl.prev(),
		    selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
		    selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

		that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
		.on('keydown', function(e){
		  if (e.which === 40){
		    that.$selectableUl.focus();
		    return false;
		  }
		});

		that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
		.on('keydown', function(e){
		  if (e.which == 40){
		    that.$selectionUl.focus();
		    return false;
		  }
		});
		},
		afterSelect: function(){
		this.qs1.cache();
		this.qs2.cache();
		},
		afterDeselect: function(){
		this.qs1.cache();
		this.qs2.cache();
		}
	});

	$("form[name='add-permission']").on('submit', function(e){
		e.preventDefault();
		options = $("select#edit-permissions").val();
		
		console.log(options);
		
		my_perms = [];

		if (options != null) {
			for(i=0; i<options.length; i++) {
				model = $("option[value='"+options[i]+"']").data("model");
				my_perms.push(model+"-"+options[i]);			
			}
			console.log(my_perms);
		}
		
		
		user_id = $("input[name='user_id']").val();
		
		$.ajax({
	    	type: "POST",
	    	url: "/scomuser/permission/add/",
	    	data: {
				'selected_permissions': my_perms,
				'user_id': user_id
			},
	    	success: function(data) {
	    		console.log("Success");
	    		alert("Permissions updated successfully");
	    	},
	    	error: function(errors) {
	    		console.log("errors");
	    	}
	    })
	});

})(jQuery)

</script>